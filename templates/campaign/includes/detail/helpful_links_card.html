<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h5 class="mb-0">Helpful Links</h5>
    </div>
    <div class="card-body">
        <ul id="helpful-links-list" class="list-group list-group-flush">
            {% for link in campaign.helpful_links.all %}
                <li id="link-{{ link.pk }}"
                    class="list-group-item d-flex justify-content-between align-items-center">
                    <a href="{{ link.url }}" target="_blank">{{ link.name }}</a>
                    {% if request.user == campaign.dungeon_master %}
                        <button class="btn btn-sm btn-outline-danger delete-link-btn"
                                data-link-pk="{{ link.pk }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
        {% if not campaign.helpful_links.all %}
            <p id="no-links-message" class="text-muted">No helpful links yet.</p>
        {% endif %}
        {% if request.user == campaign.dungeon_master and campaign.helpful_links.count < 20 %}
            <hr />
            <h6>Add a New Link</h6>
            <form id="add-link-form"
                  method="post"
                  action="{% url 'helpful_link_add' pk=campaign.pk %}">
                {% csrf_token %}
                <div id="add-link-errors" class="alert alert-danger hidden"></div>
                <div class="mb-3">
                    <label for="id_name" class="form-label">Name</label>
                    <input type="text" name="name" id="id_name" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label for="id_url" class="form-label">URL</label>
                    <input type="text" name="url" id="id_url" class="form-control" required />
                </div>
                <button type="submit" class="btn btn-primary">Add Link</button>
            </form>
        {% endif %}
    </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add Link
    const addLinkForm = document.getElementById('add-link-form');
    if (addLinkForm) {
      addLinkForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(addLinkForm);
        const url = addLinkForm.action;
        const csrfToken = formData.get('csrfmiddlewaretoken');

        fetch(url, {
            method: 'POST',
            body: new URLSearchParams(formData),
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-Requested-With': 'XMLHttpRequest'
            },
          })
          .then(response => response.json())
          .then(data => {
            if (data.pk) {
              const newLink = `
                        <li id="link-${data.pk}" class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="${data.url}" target="_blank">${data.name}</a>
                            <button class="btn btn-sm btn-outline-danger delete-link-btn" data-link-pk="${data.pk}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </li>`;
              const list = document.getElementById('helpful-links-list');
              list.insertAdjacentHTML('beforeend', newLink);
              addLinkForm.reset();
              // Hide the 'No helpful links yet' message if it exists
              const noLinksMessage = document.getElementById('no-links-message');
              if (noLinksMessage) {
                noLinksMessage.classList.add('hidden');
              }
            } else if (data.errors) {
              const errorDiv = document.getElementById('add-link-errors');
              let errorMessages = '';
              for (const field in data.errors) {
                errorMessages += `<p>${field}: ${data.errors[field].join(', ')}</p>`;
              }
              errorDiv.innerHTML = errorMessages;
              errorDiv.classList.remove('hidden');
            }
          })
          .catch(error => console.error('Error adding link:', error));
      });
    }

    // Delete Link
    document.getElementById('helpful-links-list').addEventListener('click', function(e) {
      const deleteButton = e.target.closest('.delete-link-btn');
      if (deleteButton) {
        const linkPk = deleteButton.dataset.linkPk;
        const url = `/links/${linkPk}/delete/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        if (confirm('Are you sure you want to delete this link?')) {
          fetch(url, {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
              },
            })
            .then(response => {
              if (response.ok) {
                document.getElementById(`link-${linkPk}`).remove();
                const list = document.getElementById('helpful-links-list');
                if (list.children.length === 0) {
                  const noLinksMessage = document.getElementById('no-links-message');
                  if (noLinksMessage) {
                    noLinksMessage.classList.remove('hidden');
                  }
                }
              } else {
                console.error('Failed to delete link');
              }
            })
            .catch(error => console.error('Error deleting link:', error));
        }
      }
    });
  });
</script>
